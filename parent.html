<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ota-ona Paneli | E-sinf</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            min-height: 100vh;
            background: #0f172a;
            color: #f8fafc;
            display: flex;
        }

        /* --- LOADER --- */
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loader {
            width: 45px;
            height: 45px;
            border: 4px solid rgba(16, 185, 129, 0.1);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: 0.3s ease;
        }

        .sidebar h2 {
            color: #10b981;
            margin-bottom: 30px;
            font-size: 20px;
            text-align: center;
            letter-spacing: 1px;
        }

        .child-profile {
            background: rgba(16, 185, 129, 0.1);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .child-avatar {
            width: 50px;
            height: 50px;
            background: #10b981;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .child-name {
            font-size: 14px;
            font-weight: 600;
            color: #f8fafc;
        }

        .child-role {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .nav-link {
            padding: 14px 18px;
            display: block;
            color: #94a3b8;
            text-decoration: none;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: 0.3s;
            font-size: 14px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-link.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            font-weight: 600;
        }

        .logout-btn {
            color: #fb7185;
            border: 1px solid rgba(251, 113, 133, 0.2);
            margin-top: auto;
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px;
            transition: 0.3s;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 24px;
            margin-bottom: 25px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: 0.3s;
        }

        .stat-card h3 {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card p {
            font-size: 28px;
            font-weight: 600;
            color: #10b981;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 15px;
            color: #94a3b8;
            font-size: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
        }

        td {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .grade-badge {
            display: inline-block;
            width: 45px;
            height: 45px;
            line-height: 45px;
            border-radius: 12px;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            font-weight: 600;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.1);
        }

        .no-grade {
            color: #475569;
            font-style: italic;
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .cam-box {
            background: #000;
            border-radius: 18px;
            aspect-ratio: 16/9;
            position: relative;
            overflow: hidden;
            border: 2px solid #1e293b;
        }

        .cam-status {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 2;
        }

        .cam-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #334155;
            background: radial-gradient(circle, #1e293b 0%, #0f172a 100%);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1;
        }

        /* Yangi Video stili */
        #liveVideo1 {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
            display: none;
            /* Boshida ko'rinmaydi */
        }

        .time-cell {
            color: #10b981;
            font-weight: 600;
            background: rgba(16, 185, 129, 0.05);
            width: 120px;
        }

        .break-row {
            background: rgba(245, 158, 11, 0.05);
            color: #f59e0b;
            font-size: 12px;
            font-weight: 600;
        }

        .subject-box {
            display: block;
            font-weight: 600;
            font-size: 14px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-item {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-left: 4px solid #10b981;
            transition: 0.3s;
        }

        .msg-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        /* --- MOBIL QO'SHIMCHALAR --- */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 260px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
                padding-top: 80px;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .camera-grid {
                grid-template-columns: 1fr;
            }

            .glass-card {
                overflow-x: auto;
                padding: 20px;
            }

            table {
                min-width: 500px;
            }
        }
    </style>
</head>

<body>

    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Menyu</button>

    <div id="loader-wrapper">
        <div class="loader"></div>
        <div class="loader-text" style="margin-top: 15px;">Farzandingiz ma'lumotlari yuklanmoqda...</div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2>SMART PARENT</h2>

        <div class="child-profile">
            <div class="child-avatar">üéì</div>
            <div class="child-name" id="sidebarChildName">Yuklanmoqda...</div>
            <div class="child-role" id="childClassInfo">10-black o'quvchisi</div>
        </div>

        <div class="nav-link active" onclick="switchTab('overview', this)">üè† Asosiy panel</div>
        <div class="nav-link" onclick="switchTab('schedule', this)">üìÖ Dars jadvali</div>
        <div class="nav-link" onclick="switchTab('camera', this)">üìπ Kamera (Live)</div>
        <div class="nav-link" onclick="switchTab('messages', this)">üí¨ Xabarnomalar</div>
        <a href="javascript:void(0)" class="nav-link logout-btn" onclick="logout()">Chiqish</a>
    </div>

    <div class="main-content">
        <div id="overview" class="section active">
            <h1 id="parentName">Xush kelibsiz!</h1>
            <p style="color: #94a3b8; margin-bottom: 30px;">Farzandingizning haftalik o'zlashtirish ko'rsatkichlari</p>

            <div class="stat-grid">
                <div class="stat-card">
                    <h3>O'rtacha ball</h3>
                    <p id="childAvg">0.0</p>
                </div>
                <div class="stat-card">
                    <h3>Davomat</h3>
                    <p style="color: #10b981;">100%</p>
                </div>
                <div class="stat-card">
                    <h3>Sinf reytingida</h3>
                    <p id="childRank">--</p>
                </div>
            </div>

            <div class="glass-card">
                <h3 style="margin-bottom: 20px; font-size: 18px; color: #10b981;">Haftalik baholar</h3>
                <div style="overflow-x: auto;">
                    <table style="min-width: 600px;">
                        <thead>
                            <tr>
                                <th>Dushanba</th>
                                <th>Seshanba</th>
                                <th>Chorshanba</th>
                                <th>Payshanba</th>
                                <th>Juma</th>
                            </tr>
                        </thead>
                        <tbody id="childGradesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="camera" class="section">
            <h1>üìπ Jonli kuzatuv</h1>
            <p style="color: #94a3b8; margin-bottom: 25px;">Sinfxonadagi jarayonlarni onlayn ko'rish</p>

            <div class="camera-grid">
                <div class="cam-box">
                    <div id="camStatus1" class="cam-status">‚óè CONNECTING...</div>

                    <video id="liveVideo1" autoplay muted playsinline></video>

                    <div id="camPlaceholder1" class="cam-placeholder">
                        <span style="font-size: 40px; margin-bottom: 10px;">üìπ</span>
                        <p style="color: #64748b;">1-Kamera: Sinf xonasi</p>
                        <small id="camNote1" style="color: #475569;">Ulanmoqda...</small>
                    </div>
                </div>

                <div class="cam-box">
                    <div class="cam-status" style="background: #475569;">OFFLINE</div>
                    <div class="cam-placeholder">
                        <span style="font-size: 40px; margin-bottom: 10px;">üìπ</span>
                        <p style="color: #64748b;">2-Kamera: Yo'lak</p>
                        <small style="color: #475569;">Kamera o'chirilgan</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="schedule" class="section">
            <h1>üìÖ Dars jadvali</h1>
            <div class="glass-card" style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Soat</th>
                            <th>Du</th>
                            <th>Se</th>
                            <th>Ch</th>
                            <th>Pa</th>
                            <th>Ju</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="time-cell">08:30 - 09:15</td>
                            <td><span class="subject-box">Matematika</span></td>
                            <td><span class="subject-box">Ona tili</span></td>
                            <td><span class="subject-box">Fizika</span></td>
                            <td><span class="subject-box">Tarix</span></td>
                            <td><span class="subject-box">Ingliz tili</span></td>
                        </tr>
                        <tr>
                            <td class="time-cell">09:25 - 10:10</td>
                            <td><span class="subject-box">Matematika</span></td>
                            <td><span class="subject-box">Kimyo</span></td>
                            <td><span class="subject-box">Geometriya</span></td>
                            <td><span class="subject-box">Jismoniy t.</span></td>
                            <td><span class="subject-box">Rus tili</span></td>
                        </tr>
                        <tr class="break-row">
                            <td colspan="6">KATTA TANAFUS (TUSHLIK VAQTI)</td>
                        </tr>
                        <tr>
                            <td class="time-cell">10:40 - 11:25</td>
                            <td><span class="subject-box">Ingliz tili</span></td>
                            <td><span class="subject-box">Fizika</span></td>
                            <td><span class="subject-box">Informatika</span></td>
                            <td><span class="subject-box">Matematika</span></td>
                            <td><span class="subject-box">Biologiya</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="messages" class="section">
            <h1>üí¨ Xabarnomalar</h1><br>
            <div class="glass-card">
                <div class="msg-item">
                    <h4 style="color:#10b981">Chorak yakuni yaqinlashmoqda</h4>
                    <p style="color:#94a3b8; font-size: 13px;">Tayyorgarlikni nazorat qiling.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
        let stream = null; // Kamera oqimini saqlash uchun o'zgaruvchi
        let previousGrades = {}; // Baholar o'zgarishini kuzatish uchun

        // Mobil sidebar funksiyasi
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function getStudentsFromBase() {
            const allUsers = JSON.parse(localStorage.getItem('usersList')) || [];
            return allUsers.filter(u => u.role === 'student');
        }

        window.onload = function () {
            // Kamera vaqtini darhol tekshirish
            checkCameraTime();
            // Har soniyada vaqtni tekshirishni yoqish
            setInterval(checkCameraTime, 1000);

            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || user.role !== 'parent') {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('parentName').innerText = "Assalomu alaykum, " + user.fullName + "!";
            const students = getStudentsFromBase();
            const myChild = students.find(s => s.login === user.info);

            if (myChild) {
                document.getElementById('sidebarChildName').innerText = myChild.fullName;
                // Boshlang'ich baholarni saqlab olamiz
                captureInitialGrades(user.info);
                renderChildStats(user.info, students);
                updateAttendanceStats(user.info); // Initial check

                // POLLING: Har 2 soniyada yangilash
                setInterval(() => {
                    checkGradeChanges(user.info);
                    updateAttendanceStats(user.info);
                }, 2000);
            }

            setTimeout(() => {
                document.getElementById("loader-wrapper").classList.add("loader-hidden");
            }, 800);

            // Event listener ham qoladi (qo'shimcha himoya)
            window.addEventListener('storage', function (e) {
                if (e.key === 'journalData') {
                    checkGradeChanges(user.info);
                }
                if (e.key === 'attendanceData') {
                    updateAttendanceStats(user.info);
                }
            });
        };

        function captureInitialGrades(childLogin) {
            const journal = JSON.parse(localStorage.getItem('journalData')) || {};
            const grades = journal[childLogin] || {};
            // Nusxasini saqlaymiz
            previousGrades = { ...grades };
        }

        function checkGradeChanges(childLogin) {
            const journal = JSON.parse(localStorage.getItem('journalData')) || {};
            const currentGrades = journal[childLogin] || {};

            let hasChange = false;

            // Har bir kunni tekshiramiz
            days.forEach(day => {
                const oldVal = previousGrades[day];
                const newVal = currentGrades[day];

                // Agar yangi baho qo'yilgan bo'lsa yoki o'zgargan bo'lsa
                if (newVal && newVal !== "" && newVal != oldVal) {

                    // Ovozli xabar
                    speakNotification(`Farzandingizga ${newVal} baho qo'yildi!`);
                    hasChange = true;
                }
            });

            if (hasChange) {
                // Holatni yangilaymiz
                previousGrades = { ...currentGrades };

                // Jadvalni ham yangilaymiz
                const students = getStudentsFromBase();
                renderChildStats(childLogin, students);
            }
        }

        function updateAttendanceStats(childLogin) {
            const attendanceDB = JSON.parse(localStorage.getItem('attendanceData')) || {};
            let presentCount = 0;
            let totalDays = 0;

            // Barcha sanalarni tekshiramiz
            Object.values(attendanceDB).forEach(dayRecord => {
                if (dayRecord && dayRecord[childLogin] !== undefined) {
                    totalDays++;
                    if (dayRecord[childLogin] === true) {
                        presentCount++;
                    }
                }
            });

            // Foizni hisoblash
            let percentage = 100;
            if (totalDays > 0) {
                percentage = (presentCount / totalDays) * 100;
            }

            // UI ni yangilash
            const statCards = document.querySelectorAll('.stat-card');
            if (statCards.length >= 2) {
                const davomatCard = statCards[1];
                const pTag = davomatCard.querySelector('p');
                if (pTag) {
                    pTag.innerText = Math.round(percentage) + "%";
                }
            }
        }

        function speakNotification(text) {
            if ('speechSynthesis' in window) {
                // Avvalgi gaplarni to'xtatish (navbatma-navbat gapirmasligi uchun)
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'uz-UZ'; // O'zbek tili (agar brauzerda bor bo'lsa)
                // Agar o'zbek tili bo'lmasa, rus yoki ingliz aksentida o'qishi mumkin, 
                // lekin matn o'zbekcha bo'lgani uchun tushunarli bo'ladi.
                utterance.rate = 0.9; // Biroz sekinroq
                window.speechSynthesis.speak(utterance);
            } else {
                console.error("Browser does not support TTS");
            }
        }

        function renderChildStats(childLogin, students) {
            const journal = JSON.parse(localStorage.getItem('journalData')) || {};
            const grades = journal[childLogin] || {};
            let sum = 0, count = 0;
            const html = days.map(day => {
                const val = grades[day];
                if (val && val !== "") {
                    sum += Number(val);
                    count++;
                    return `<td><span class="grade-badge">${val}</span></td>`;
                }
                return `<td><span class="no-grade">‚Äî</span></td>`;
            }).join('');
            document.getElementById('childGradesBody').innerHTML = `<tr>${html}</tr>`;
            const avg = count > 0 ? (sum / count).toFixed(1) : "0.0";
            document.getElementById('childAvg').innerText = avg;
        }

        function switchTab(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');

            // Telefonda menyu bosilganda yopilishi uchun
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // --- YANGILANGAN KAMERA LOGIKASI ---
        function checkCameraTime() {
            const now = new Date();
            const day = now.getDay(); // 0-Yakshanba, 6-Shanba
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const totalMinutes = hours * 60 + minutes;

            let shouldBeWorking = false;
            let noteText = "Hozir dars vaqti emas";

            // VAQT MANTIQI:
            if (day === 0) { // Yakshanba
                shouldBeWorking = false;
            } else if (day === 6) { // Shanba
                if (hours < 12) {
                    shouldBeWorking = true;
                }
            } else { // Dushanba - Juma
                if (totalMinutes >= 480 && totalMinutes < 1000) { // 08:00 - 16:40
                    shouldBeWorking = true;
                }
            }

            const status1 = document.getElementById('camStatus1');
            const note1 = document.getElementById('camNote1');

            if (shouldBeWorking) {
                // Agar vaqt to'g'ri bo'lsa, kamerani yoqishga harakat qilamiz
                if (!stream) {
                    startCamera(); // Kamera hali yonmagan bo'lsa, yoqamiz
                } else {
                    // Kamera allaqachon ishlayapti
                    if (status1) {
                        status1.innerText = "‚óè LIVE";
                        status1.style.background = "rgba(239, 68, 68, 0.8)";
                        note1.innerText = "Jonli efir uzatilmoqda";
                    }
                }
            } else {
                // Agar vaqt to'g'ri kelmasa, kamerani o'chiramiz
                stopCamera();
                if (status1) {
                    status1.innerText = "OFFLINE";
                    status1.style.background = "#475569";
                    note1.innerText = noteText;
                }
            }
        }

        // Kamerani ishga tushirish funksiyasi
        async function startCamera() {
            const videoElement = document.getElementById('liveVideo1');
            const placeholder = document.getElementById('camPlaceholder1');
            const status1 = document.getElementById('camStatus1');
            const note1 = document.getElementById('camNote1');

            try {
                // Brauzerdan kamera ruxsatini so'rash
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;

                // Video o'lchamlarini to'g'rilash
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    videoElement.style.display = 'block'; // Videoni ko'rsatish
                    placeholder.style.display = 'none'; // Rasmni yashirish
                };

            } catch (err) {
                // Agar ruxsat berilmasa yoki kamera bo'lmasa
                console.error("Kamera xatosi:", err);
                stopCamera(); // Tozalash

                status1.innerText = "SIGNAL YO'Q";
                status1.style.background = "#f59e0b"; // Sariq rang
                note1.innerText = "Kameraga ulanib bo'lmadi (Ruxsat yo'q)";
            }
        }

        // Kamerani to'xtatish funksiyasi
        function stopCamera() {
            const videoElement = document.getElementById('liveVideo1');
            const placeholder = document.getElementById('camPlaceholder1');

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            if (videoElement) {
                videoElement.style.display = 'none';
                videoElement.srcObject = null;
            }
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
        }
    </script>
</body>

</html>
